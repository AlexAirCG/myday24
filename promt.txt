// fiels ============================================================================================	      
app
app/api
app/api/auth/[...nextauth]/route.ts
app/api/todos/reorder/route.ts
app/dashboard/shop/page.tsx
app/dashboard/todo/[id]/edit/page.tsx
app/dashboard/todo/page.tsx
app/dashboard/layout.tsx
app/dashboard/page.tsx
app/lib/actions.ts
app/lib/data.ts
app/lib/definitions.ts
app/login/page.tsx
app/register/page.tsx
app/ui/dashboard/nav-links.tsx
app/ui/dashboard/sidenav.tsx
app/ui/shop/table-todo-shop.tsx
app/ui/todo/breadcrumbs.tsx
app/ui/todo/buttons.tsx
app/ui/todo/checkbox-todo.tsx
app/ui/todo/create-todo.tsx
app/ui/todo/edit-todo-input.tsx
app/ui/todo/edit-todo.tsx
app/ui/acme-logo.tsx
app/ui/button.tsx
app/ui/fonts.ts
app/ui/global.css
app/ui/login-form.tsx
app/ui/register-form.tsx
app/ui/shop.module.css
app/ui/submit-button.tsx
app/layout.tsx
app/page.tsx
auth.config.ts
auth.ts

// postgreSQL ============================================================================================
// users =========
id	 uuid [uuid_generate_v4()]	
name	 character varying(255)	
email	 text	
password text NULL	
–ò–Ω–¥–µ–∫—Å—ã
UNIQUE	email
PRIMARY	id
// todo_myday ==========
id	    uuid [uuid_generate_v4()]	
title	    text	
completed   boolean NULL [false]	
sort_order  integer NULL	
user_id	    uuid
–ò–Ω–¥–µ–∫—Å—ã
PRIMARY	id
INDEX	sort_order, id
INDEX	user_id
INDEX	user_id, sort_order, id
UNIQUE	user_id, sort_order


// app/api/auth/[...nextauth]/route.ts ====================================================================
export { GET, POST } from "@/auth";

// app/api/todos/reorder/route.ts =========================================================================
import { revalidatePath } from "next/cache";
import { NextResponse } from "next/server";
import postgres from "postgres";
import { auth } from "@/auth";

const sql = postgres(process.env.POSTGRES_URL!, { ssl: "require" });

export async function POST(req: Request) {
  try {
    const session = await auth();
    const userId = session?.user?.id;
    if (!userId)
      return NextResponse.json(
        { ok: false, error: "Unauthorized" },
        { status: 401 }
      );

    const { ids } = (await req.json()) as { ids?: string[] };

    if (!Array.isArray(ids) || ids.length === 0) {
      return NextResponse.json(
        { ok: false, error: "ids must be a non-empty array" },
        { status: 400 }
      );
    }

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    await sql.begin(async (tx) => {
      // Option 1: Using unnest (PostgreSQL)
      await tx`
    WITH new_orders AS (
      SELECT unnest(${sql.array(ids)}::uuid[]) AS id,
             unnest(${sql.array(ids.map((_, i) => i + 1))}::int[]) AS new_order
    )
    UPDATE todo_myday
    SET sort_order = new_orders.new_order
    FROM new_orders
    WHERE todo_myday.id = new_orders.id 
      AND todo_myday.user_id = ${userId}
  `;
    });

    revalidatePath("/dashboard/todo");
    return NextResponse.json({ ok: true });
  } catch (err) {
    console.error("reorder error", err);
    return NextResponse.json(
      { ok: false, error: "Internal Server Error" },
      { status: 500 }
    );
  }
}

// app/dashboard/shop/page.tsx ===========================================================================
import { inter } from "@/app/ui/fonts";

export const dynamic = "force-dynamic";

export default async function Page() {
  return (
    <div className="w-full">
      <div className="flex w-full items-center justify-between">
        <h1 className={`${inter.className} text-2xl`}>–î–µ–ª–∞</h1>
      </div>
    </div>
  );
}

// app/dashboard/todo/[id]/edit/page.tsx ==================================================================
import { fetchTodoById } from "@/app/lib/data";
import Breadcrumbs from "@/app/ui/todo/breadcrumbs";
import EditTodo from "@/app/ui/todo/edit-todo";
export default async function Page(props: { params: Promise<{ id: string }> }) {
  const params = await props.params;
  const id = params.id;
  const [title] = await Promise.all([fetchTodoById(id)]);
  return (
    <main>
      <Breadcrumbs
        breadcrumbs={[
          { label: "–î–µ–ª–∞", href: "/dashboard/todo" },
          {
            label: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∫—É–ø–∫—É",
            href: `/dashboard/todo/${id}/edit`,
            active: true,
          },
        ]}
      />
      <EditTodo title={title} />
    </main>
  );
}

// app/dashboard/todo/page.tsx ========================================================================
import { fetchTodo } from "@/app/lib/data";
import { inter } from "@/app/ui/fonts";
import TableTodoShop from "@/app/ui/shop/table-todo-shop";
import CreateTodo from "@/app/ui/todo/create-todo";
export const dynamic = "force-dynamic";
export default async function Page() {
  const todos = await fetchTodo();
  return (
    <div className="flex h-full flex-col overflow-hidden">
      {/* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∞–ø–∫–∞ (–Ω–µ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç—Å—è) */}
      <div className="sticky top-0 z-10 flex flex-col w-full bg-sky-200 md:p-2">
        <h1 className={`${inter.className} text-2xl md:mb-6`}>–î–µ–ª–∞</h1>
        <CreateTodo />
      </div>
      {/* –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º–∞—è —á–∞—Å—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ø–∏—Å–∫–∞ */}
      <div
        className="flex-1 min-h-0 overflow-y-auto md:p-2 overscroll-contain"
        style={{ WebkitOverflowScrolling: "touch" }}
      >
        <div className="mt-4 flex items-center justify-between gap-2 md:mt-8">
          {/* <Search placeholder="Search city..." /> */}
        </div>
        <TableTodoShop todos={todos} />
      </div>
    </div>
  );
}

// app/dashboard/layout.tsx ============================================================================
import SideNav from "../ui/dashboard/sidenav";
import { fetchUserEmail } from "../lib/data";
import SideNav from "../ui/dashboard/sidenav";
export const dynamic = "force-dynamic";
export default async function Layout({
  children,
}: {
  children: React.ReactNode;
}) {
  const email = await fetchUserEmail(); // string | null
  return (
    <div className="flex h-[100svh] flex-col md:flex-row overflow-hidden">
      <div className="flex-none w-full md:w-64">
        {/* ‚úÖ –ü–µ—Ä–µ–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É/nullable */}
        <SideNav email={email} />
      </div>
      <div className="flex-1 min-h-0 bg-sky-200 p-3 md:p-12 overflow-hidden">
        {children}
      </div>
    </div>
  );
}

// app/dashboard/page.tsx ===========================================================================
"use client";
import { useState } from "react";
import { CiBatteryEmpty, CiBatteryFull } from "react-icons/ci";
import { TbAccessPoint } from "react-icons/tb";
import { TbAccessPointOff } from "react-icons/tb";
export const dynamic = "force-dynamic";
export default function Page() {
  const [showPass, setShowPass] = useState(true);
  const [showPower, setShowPower] = useState(true);
  return (
    <div>
      <button type="button" onClick={() => setShowPass(!showPass)}>
        {showPass ? (
          <TbAccessPoint className="w-10 h-10" />
        ) : (
          <TbAccessPointOff className="w-10 h-10" />
        )}
      </button>
      <button type="button" onClick={() => setShowPower(!showPower)}>
        {showPower ? (
          <CiBatteryEmpty className="w-10 h-10" />
        ) : (
          <CiBatteryFull className="w-10 h-10" />
        )}
      </button>
    </div>
  );
}

// app/lib/actions.ts ==================================================================================
"use server";
import { revalidatePath } from "next/cache";
import { redirect } from "next/navigation";
import postgres from "postgres";
import z from "zod";
import { signIn } from "@/auth";
import { AuthError } from "next-auth";
import bcrypt from "bcryptjs";
import { auth } from "@/auth";

const sql = postgres(process.env.POSTGRES_URL!, { ssl: "require" });

const FormSchema = z.object({
  id: z.string(),
  title: z.string(),
});
// + —Å—Ö–µ–º–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ id
const DeleteSchema = z.object({
  id: z.uuid(),
});
export type DeleteState = { ok: boolean; id?: string; error?: string };

export async function createTodoFetch(formData: FormData) {
  const session = await auth();
  const userId = session?.user?.id;

  console.log("Creating todo for userId:", userId);

  if (!userId) throw new Error("Unauthorized");

  const title = String(formData.get("title") || "").trim();
  if (!title) return;

  await sql`
    INSERT INTO todo_myday (id, title, completed, sort_order, user_id)
    VALUES (gen_random_uuid(), ${title}, false,
      COALESCE((SELECT MAX(sort_order) + 1 FROM todo_myday WHERE user_id=${userId}), 1),
      ${userId}
    )
  `;

  revalidatePath("/dashboard/todo");
}

export async function updateTodo(id: string, formData: FormData) {
  const session = await auth();
  const userId = session?.user?.id;
  if (!userId) throw new Error("Unauthorized");

  const { title } = FormSchema.parse({
    title: formData.get("title"),
    id: formData.get("id") ?? "",
  });

  await sql`
    UPDATE todo_myday
    SET title = ${title}
    WHERE id = ${id} AND user_id = ${userId}
  `;

  revalidatePath("/dashboard/todo");
  redirect("/dashboard/todo");
}

export async function deleteTodoTask(_prev: DeleteState, formData: FormData) {
  const session = await auth();
  const userId = session?.user?.id;
  if (!userId) return { ok: false, error: "Unauthorized" };

  const id = String(formData.get("id") ?? "");
  const parsed = DeleteSchema.safeParse({ id });
  if (!parsed.success) {
    return { ok: false, id, error: "–ù–µ–≤–µ—Ä–Ω—ã–π id" };
  }

  try {
    await sql`DELETE FROM todo_myday WHERE id = ${id} AND user_id = ${userId}`;
    revalidatePath("/dashboard/todo");
    return { ok: true, id };
  } catch {
    return { ok: false, id, error: "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è" };
  }
}

export async function toggleTodo(id: string) {
  const session = await auth();
  const userId = session?.user?.id;
  if (!userId) throw new Error("Unauthorized");

  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏
  const [current] = await sql<{ completed: boolean }[]>`
    SELECT completed FROM todo_myday 
    WHERE id = ${id} AND user_id = ${userId}
  `;

  if (!current) throw new Error("Task not found");

  const willBeCompleted = !current.completed;

  // –ü–æ–ª—É—á–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π sort_order –¥–ª—è —Ü–µ–ª–µ–≤–æ–π –≥—Ä—É–ø–ø—ã (completed –∏–ª–∏ –Ω–µ completed)
  const [maxOrder] = await sql<{ max_order: number | null }[]>`
    SELECT MAX(sort_order) as max_order
    FROM todo_myday
    WHERE user_id = ${userId} AND completed = ${willBeCompleted}
  `;

  const newSortOrder = (maxOrder?.max_order ?? 0) + 1;

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ sort_order
  await sql`
    UPDATE todo_myday
    SET completed = ${willBeCompleted}, sort_order = ${newSortOrder}
    WHERE id = ${id} AND user_id = ${userId}
  `;

  revalidatePath("/dashboard/todo");
}

// export async function toggleTodo(id: string) {
//   const session = await auth();
//   const userId = session?.user?.id;
//   if (!userId) throw new Error("Unauthorized");

//   await sql`
//     UPDATE todo_myday
//     SET completed = NOT completed
//     WHERE id = ${id} AND user_id = ${userId}
//   `;
//   revalidatePath("/dashboard/todo");
// }

export async function authenticate(
  prevState: string | undefined,
  formData: FormData
) {
  try {
    await signIn("credentials", formData);
  } catch (error) {
    if (error instanceof AuthError) {
      switch (error.type) {
        case "CredentialsSignin":
          return "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å.";
        default:
          return "–ß—Ç–æ —Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫.";
      }
    }
    throw error;
  }
}

// —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è useActionState
export type RegisterState = {
  ok: boolean;
  message?: string;
  errors?: Partial<Record<"name" | "email" | "password" | "confirm", string>>;
};

const RegisterSchema = z
  .object({
    name: z.string().min(1, "–í–≤–µ–¥–∏—Ç–µ –∏–º—è"),
    email: z.email("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email"),
    password: z.string().min(6, "–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤"),
    confirm: z.string().min(6),
    redirectTo: z.string().optional(),
  })
  .refine((v) => v.password === v.confirm, {
    path: ["confirm"],
    message: "–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç",
  });

export async function register(
  _prev: RegisterState | undefined,
  formData: FormData
): Promise<RegisterState> {
  const parsed = RegisterSchema.safeParse({
    name: formData.get("name"),
    email: formData.get("email"),
    password: formData.get("password"),
    confirm: formData.get("confirm"),
    redirectTo: formData.get("redirectTo") || "/dashboard",
  });

  if (!parsed.success) {
    const fieldErrors: RegisterState["errors"] = {};
    for (const issue of parsed.error.issues) {
      const key = issue.path[0] as keyof NonNullable<RegisterState["errors"]>;
      fieldErrors[key] = issue.message;
    }
    return { ok: false, errors: fieldErrors };
  }

  const { name, email, password, redirectTo } = parsed.data;

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è email
  const exists = await sql<{ exists: boolean }[]>`
    SELECT EXISTS(SELECT 1 FROM users WHERE email=${email}) as exists
  `;
  if (exists[0]?.exists) {
    return {
      ok: false,
      errors: { email: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" },
    };
  }

  // –•—ç—à –ø–∞—Ä–æ–ª—è –∏ –≤—Å—Ç–∞–≤–∫–∞
  const hash = await bcrypt.hash(password, 10);
  await sql`
    INSERT INTO users (name, email, password)
    VALUES (${name}, ${email}, ${hash})
  `;

  // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –≥–¥–µ –Ω—É–∂–Ω–æ (–µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≤–∏—Å–∏–º—ã–µ —Å–ø–∏—Å–∫–∏/—Å—Ç—Ä–∞–Ω–∏—Ü—ã)
  revalidatePath("/");

  // –ê–≤—Ç–æ–≤—Ö–æ–¥ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  try {
    await signIn("credentials", {
      email,
      password,
      redirectTo: redirectTo || "/dashboard",
    });
    // signIn –±—Ä–æ—Å–∏—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç ‚Äî —Å—é–¥–∞ –æ–±—ã—á–Ω–æ –Ω–µ –¥–æ–π–¥—ë–º
    return { ok: true };
  } catch (error) {
    if (error instanceof AuthError) {
      // –ï—Å–ª–∏ –ª–æ–≥–∏–Ω –Ω–µ —É–¥–∞–ª—Å—è ‚Äî –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –ø—Ä–æ—Å–∏–º –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –≤—Ä—É—á–Ω—É—é
      return {
        ok: true,
        message: "–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω. –í–æ–π–¥–∏—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É—è —Å–≤–æ–π email –∏ –ø–∞—Ä–æ–ª—å.",
      };
    }
    throw error;
  }
}

// app/lib/data.ts ==================================================================================
import postgres from "postgres";
import { Todo, User } from "./definitions";
import { auth } from "@/auth";

const sql = postgres(process.env.POSTGRES_URL!, { ssl: "require" });

export async function fetchTodo() {
  const session = await auth();
  const userId = session?.user?.id;

  console.log("üìã fetchTodo called");
  console.log("   Session:", JSON.stringify(session, null, 2));
  console.log("   UserId:", userId);

  if (!userId) {
    console.warn("‚ö†Ô∏è No userId in session!");
    return [];
  }

  try {
    const todos = await sql<Todo[]>`
      SELECT id, title, completed, user_id
      FROM todo_myday
      WHERE user_id = ${userId}
      ORDER BY completed ASC, sort_order ASC, id ASC
    `;
    console.log(`‚úÖ Found ${todos.length} todos for user ${userId}`);
    return todos;
  } catch (error) {
    console.error("‚ùå Database Error:", error);
    throw new Error("Failed to fetch Todo");
  }
}

export async function fetchTodoById(id: string) {
  const session = await auth();
  const userId = session?.user?.id;
  if (!userId) throw new Error("Unauthorized");

  try {
    const data = await sql<Todo[]>`
      SELECT id, title, completed
      FROM todo_myday
      WHERE id = ${id} AND user_id = ${userId};
    `;

    return data[0];
  } catch (error) {
    console.error("Database Error:", error);
    throw new Error("Failed to fetch invoice.");
  }
}

// –í–æ–∑–≤—Ä–∞—â–∞–µ–º email —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É)
export async function fetchUserEmail(): Promise<string | null> {
  try {
    const session = await auth();
    const sessionEmail = session?.user?.email ?? null;
    if (sessionEmail) return sessionEmail;

    const userId = session?.user?.id;
    if (!userId) return null;

    const rows = await sql<{ email: string }[]>`
      SELECT email
      FROM users
      WHERE id = ${userId}
      LIMIT 1
    `;
    return rows[0]?.email ?? null;
  } catch (error) {
    console.error("Database Error:", error);
    return null;
  }
}

// app/lib/definitions.ts ===========================================================================
export type Todo = {
  id: string;
  title: string;
  completed: boolean;
};

export type User = {
  id: string;
  name: string;
  email: string;
  password: string;
};

// app/login/page.tsx ===============================================================================
import AcmeLogo from "@/app/ui/acme-logo";

import { Suspense } from "react";
import LoginForm from "../ui/login-form";

export default function LoginPage() {
  return (
    <main className="flex items-center justify-center md:h-screen">
      <div className="relative mx-auto flex w-full max-w-[400px] flex-col space-y-2.5 p-4">
        <div className="flex w-full items-center justify-center rounded-lg bg-gradient-to-br from-blue-200 to-blue-600 shadow-[0_4px_8px_rgba(0,0,0,0.5)] p-3 h-20 md:h-25">
          <div className="w-32 text-white md:w-36">
            <AcmeLogo />
          </div>
        </div>
        <Suspense>
          <LoginForm />
        </Suspense>
      </div>
    </main>
  );
}

// app/register/page.tsx ============================================================================
import AcmeLogo from "@/app/ui/acme-logo";
import { Suspense } from "react";
import RegisterForm from "../ui/register-form";

export default function RegisterPage() {
  return (
    <main className="flex items-center justify-center md:h-screen">
      <div className="relative mx-auto flex w-full max-w-[400px] flex-col space-y-2.5 p-4 md:mt-20">
        {/* <div className="flex h-20 w-full items-end rounded-lg bg-blue-500 p-3 md:h-36"> */}
        <div className="flex w-full items-center justify-center rounded-lg bg-gradient-to-br from-blue-200 to-blue-600 shadow-[0_4px_8px_rgba(0,0,0,0.5)] p-3 h-20 md:h-25">
          <div className="w-32 text-white md:w-36">
            <AcmeLogo />
          </div>
        </div>
        <Suspense>
          <RegisterForm />
        </Suspense>
      </div>
    </main>
  );
}

// app/ui/dashboard/nav-links.tsx ====================================================================
"use client";

import clsx from "clsx";
import Link from "next/link";
import { usePathname } from "next/navigation";
import { FaShopify } from "react-icons/fa6";
import { LuListTodo } from "react-icons/lu";
import { IoCalendarNumberOutline } from "react-icons/io5";
import { CiMemoPad } from "react-icons/ci";

// –ö–∞—Ä—Ç–∞ —Å—Å—ã–ª–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –±–æ–∫–æ–≤–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.

export default function NavLinks() {
  const pathName = usePathname(); // —Ç–µ–∫—É—â–∏–π –ø—É—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ URL.
  return (
    <>
      <Link
        className={clsx(
          "flex grow items-center justify-center gap-2 rounded-md bg-gray-200 p-2 text-[16px] font-medium hover:bg-sky-200 hover:text-blue-600 md:flex-none md:justify-start md:p-2 md:px-3",
          {
            "bg-sky-200 text-blue-600": pathName === "/dashboard",
          }
        )}
        href={"/dashboard"}
      >
        <IoCalendarNumberOutline className="w-6 h-6" />
        –ö–∞–ª–µ–Ω–¥–∞—Ä—å
      </Link>
      <Link
        className={clsx(
          "flex  grow items-center justify-center gap-2 rounded-md bg-gray-200 p-2 text-[16px] font-medium hover:bg-sky-200 hover:text-blue-600 md:flex-none md:justify-start md:p-2 md:px-3",
          {
            "bg-sky-200 text-blue-600": pathName === "/dashboard/todo",
          }
        )}
        href={"/dashboard/todo"}
      >
        <CiMemoPad className="w-6 h-6" />
        –î–µ–ª–∞
      </Link>
      <Link
        className={clsx(
          "flex grow items-center justify-center gap-2 rounded-md bg-gray-200 p-2 text-[16px] font-medium hover:bg-sky-200 hover:text-blue-600 md:flex-none md:justify-start md:p-2 md:px-3",
          {
            "bg-sky-200 text-blue-600": pathName === "/dashboard/shop",
          }
        )}
        href={"/dashboard/shop"}
      >
        <FaShopify className="w-6 h-6" />
        –ü–æ–∫—É–ø–∫–∏
      </Link>
    </>
  );
}

// app/ui/dashboard/sidenav.tsx =======================================================================
import Link from "next/link";
import AcmeLogo from "../acme-logo";
import NavLinks from "./nav-links";
import { FaPowerOff } from "react-icons/fa6";
import { IoPowerSharp } from "react-icons/io5";
import { signOut } from "@/auth";
import { SubmitButton } from "../submit-button";

type SideNavProps = { email?: string | null };

export default function SideNav({ email }: SideNavProps) {
  return (
    <div className="flex flex-col p-2 md:h-full md:px-2">
      <div className="mb-2 flex  items-center justify-between rounded-md bg-blue-600 p-2 md:h-40 bg-gradient-to-br from-blue-200 to-blue-600">
        <Link href="/dashboard">
          <div className=" text-white ">
            <AcmeLogo />
          </div>
        </Link>
        <div
          className="text-white text-sm md:text-base truncate max-w-[50%]"
          title={email ?? ""}
        >
          {email ?? ""}
        </div>
        <form
          action={async () => {
            "use server";
            await signOut({ redirectTo: "/" });
          }}
          className="md:hidden"
        >
          <SubmitButton className="py-1 px-2">
            <IoPowerSharp className="w-6 h-6 text-amber-50" />
          </SubmitButton>
        </form>
      </div>
      <div className="flex grow flex-row justify-between space-x-2 md:flex-col md:space-x-0 md:space-y-2">
        <NavLinks />
        <div className="hidden h-auto w-full grow rounded-md bg-gray-50 md:block"></div>
      </div>
      <form
        action={async () => {
          "use server";
          await signOut({ redirectTo: "/" });
        }}
        className="hidden md:block"
      >
        <button className="flex w-full grow items-center justify-center gap-2 rounded-md bg-gray-50 p-3 text-sm font-medium hover:bg-sky-100 hover:text-blue-600 md:flex-none md:justify-start md:p-2 md:px-3">
          <FaPowerOff className="w-6" />
          <div className="hidden md:block">Sign Out</div>
        </button>
      </form>
    </div>
  );
}

// app/ui/shop/table-todo-shop.tsx ===================================================================
"use client";

import { useEffect, useLayoutEffect, useRef, useState } from "react";
import { DeleteTodo, UpdateInvoiceTodo } from "../todo/buttons";
import { TbArrowsUpDown } from "react-icons/tb";
import { CheckboxTodo } from "../todo/checkbox-todo";
import { toggleTodo } from "@/app/lib/actions";

interface Todo {
  id: string;
  title: string;
  completed: boolean;
}
interface Props {
  todos: Todo[];
}

// move: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –º–∞—Å—Å–∏–≤–µ. –û–Ω–∞ –∫–æ–ø–∏—Ä—É–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π –º–∞—Å—Å–∏–≤, —É–¥–∞–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç –ø–æ –∏–Ω–¥–µ–∫—Å—É from –∏ –≤—Å—Ç–∞–≤–ª—è–µ—Ç –µ–≥–æ –Ω–∞ –Ω–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å to.
function move<T>(arr: T[], from: number, to: number) {
  if (from === -1 || to === -1 || from === to) return arr;
  const copy = [...arr];
  const [item] = copy.splice(from, 1);
  copy.splice(to, 0, item);
  return copy;
}

// —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç –Ω–∞ —ç–∫—Ä–∞–Ω–µ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º, –∏–≥–Ω–æ—Ä–∏—Ä—É—è —Ç–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ—Ç—Å—è. –≠—Ç–æ
// –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –≤—ã–±–æ—Ä–∞ —Å–∞–º–æ–≥–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞.
function elementFromPointIgnoringDragged(
  x: number,
  y: number,
  draggedId: string | null
): HTMLElement | null {
  const draggedEl = draggedId
    ? (document.querySelector(`[data-id="${draggedId}"]`) as HTMLElement | null)
    : null;

  let saved: string | null = null;
  if (draggedEl) {
    saved = draggedEl.style.pointerEvents;
    draggedEl.style.pointerEvents = "none";
  }
  const el = document.elementFromPoint(x, y) as HTMLElement | null;
  if (draggedEl) {
    draggedEl.style.pointerEvents = saved ?? "";
  }
  return el;
}

// —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–ª–∏–∂–∞–π—à–∏–π —ç–ª–µ–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞—Ç—å—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ. –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ –∫—É—Ä—Å–æ—Ä –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –±–ª–∏–∑–∫–æ –∫ –∫—Ä–∞—é —ç–∫—Ä–∞–Ω–∞.
function getScrollParent(el: HTMLElement | null): HTMLElement {
  let node: HTMLElement | null = el;
  while (node && node !== document.body) {
    const style = getComputedStyle(node);
    const overflowY = style.overflowY;
    if (
      (overflowY === "auto" || overflowY === "scroll") &&
      node.scrollHeight > node.clientHeight
    ) {
      return node;
    }
    node = node.parentElement;
  }
  // fallback ‚Äî —Å—Ç—Ä–∞–Ω–∏—Ü–∞
  return (document.scrollingElement as HTMLElement) || document.documentElement;
}

export default function TableTodoShop({ todos }: Props) {
  const [list, setList] = useState<Todo[]>(todos);

  // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–µ–∫—É—â–µ–π –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–æ–π –∑–∞–¥–∞—á–∏.
  const [dragId, setDragId] = useState<string | null>(null);
  // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–¥–∞—á–∏, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –Ω–∞–≤–µ–¥–µ–Ω–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–∞—è.
  const [hoverId, setHoverId] = useState<string | null>(null);
  // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–∞—Å–∞–Ω–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤.
  const [touchXY, setTouchXY] = useState<{ x: number; y: number } | null>(null);
  // –°–º–µ—â–µ–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–∞.
  const [dragOffset, setDragOffset] = useState<{
    dx: number;
    dy: number;
  } | null>(null);
  // –†–∞–∑–º–µ—Ä—ã –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞.
  const [dragSize, setDragSize] = useState<{ w: number; h: number } | null>(
    null
  );

  //—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç list)
  const incompleteTodos = list.filter((t) => !t.completed);
  const completedTodos = list.filter((t) => t.completed);

  // –í—Å–µ useRef
  const snapshotRef = useRef<Todo[] | null>(null);
  const deleteSnapshotRef = useRef<Todo[] | null>(null);
  const prevIdsRef = useRef<Set<string>>(new Set(todos.map((t) => t.id)));
  const lastCreatedIdRef = useRef<string | null>(null);
  // –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ touch-–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –≤–æ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ dnd
  const containerRef = useRef<HTMLDivElement | null>(null);
  // –•—Ä–∞–Ω–∏–ª–∏—â–µ –∫–ª–æ–Ω–∞ –¥–ª—è –º—ã—à–∏
  const dragImageRef = useRef<HTMLElement | null>(null);
  const lastAutoScroll = useRef<number>(0);

  // ‚úÖ 4. –§—É–Ω–∫—Ü–∏–∏-—Ö–µ–ª–ø–µ—Ä—ã
  function flashRow(el: HTMLElement) {
    el.classList.add("ring-2", "ring-emerald-400", "animate-pulse");
    setTimeout(() => {
      el.classList.remove("ring-2", "ring-emerald-400", "animate-pulse");
    }, 500);
  }
  // –£–º–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
  useEffect(() => {
    if (dragId) return; // ‚úÖ dragId —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω –≤—ã—à–µ

    const prev = prevIdsRef.current;
    const nextSet = new Set(todos.map((t) => t.id));
    const newTodo = todos.find((t) => !prev.has(t.id)) || null;

    prevIdsRef.current = nextSet;

    setList((prevList) => {
      const hasStructuralChanges =
        todos.length !== prevList.length ||
        todos.some((t) => !prevList.find((p) => p.id === t.id)) ||
        prevList.some((p) => !todos.find((t) => t.id === p.id));

      if (hasStructuralChanges) {
        return todos;
      }

      const hasDataChanges = todos.some((todo) => {
        const prevTodo = prevList.find((t) => t.id === todo.id);
        return (
          prevTodo &&
          (prevTodo.completed !== todo.completed ||
            prevTodo.title !== todo.title)
        );
      });

      return hasDataChanges ? todos : prevList;
    });

    lastCreatedIdRef.current = newTodo?.id ?? null;
  }, [todos, dragId]);

  // 2) –°–∫—Ä–æ–ª–ª–∏–º –ü–û–°–õ–ï —Ç–æ–≥–æ, –∫–∞–∫ DOM –æ–±–Ω–æ–≤–∏–ª—Å—è
  useLayoutEffect(() => {
    const id = lastCreatedIdRef.current;
    if (!id) return;

    let attempts = 0;
    const tryScroll = () => {
      const el = document.querySelector<HTMLElement>(`[data-id="${id}"]`);
      if (el) {
        // block: 'end' –∏–ª–∏ 'center' –æ–±—ã—á–Ω–æ –Ω–∞–¥—ë–∂–Ω–µ–µ, —á–µ–º 'nearest'
        el.scrollIntoView({
          block: "end",
          inline: "nearest",
          behavior: "smooth",
        });
        flashRow(el);
        lastCreatedIdRef.current = null;
      } else if (attempts++ < 3) {
        // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –µ—â—ë –Ω–µ –≤ DOM, –ø–æ–¥–æ–∂–¥—ë–º 1‚Äì2 –∫–∞–¥—Ä–∞
        requestAnimationFrame(tryScroll);
      } else {
        // –§–æ–ª–ª–±–µ–∫ ‚Äî –ø—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –≤ —Å–∞–º—ã–π –Ω–∏–∑ —Å–∫—Ä–æ–ª–ª-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä/—Å—Ç—Ä–∞–Ω–∏—Ü—É
        const scrollEl = getScrollParent(containerRef.current);
        if (scrollEl) scrollEl.scrollTop = scrollEl.scrollHeight;
        lastCreatedIdRef.current = null;
      }
    };

    // –ñ–¥—ë–º –∫–∞–¥—Ä –ø–æ—Å–ª–µ –∫–æ–º–º–∏—Ç–∞ –∏ –ø—Ä–æ–±—É–µ–º
    requestAnimationFrame(tryScroll);
  }, [list.length]);

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ–±—ã—Ç–∏—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –º—ã—à–∏. –û–Ω –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á, —á—Ç–æ–±—ã –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á—É.
  const onMouseDragOverCapture = (e: React.DragEvent<HTMLDivElement>) => {
    if (!dragId) return;
    e.preventDefault();

    const x = e.clientX;
    const y = e.clientY;

    const scrollEl = getScrollParent(containerRef.current);
    autoScrollIfNearEdgeXY(scrollEl, x, y);

    const el = elementFromPointIgnoringDragged(x, y, dragId);
    const row = el ? (el.closest("[data-id]") as HTMLElement | null) : null;

    if (!row) {
      setHoverId(null);
      if (e.dataTransfer) e.dataTransfer.dropEffect = "none";
      return;
    }

    const targetId = row.dataset.id!;
    setHoverId(targetId);

    setList((prev) => {
      const from = prev.findIndex((t) => t.id === dragId);
      const to = prev.findIndex((t) => t.id === targetId);
      if (from === -1 || to === -1) return prev;

      const rect = row.getBoundingClientRect();
      const overBottomHalf = y - rect.top > rect.height / 2;

      // –í—Å—Ç–∞–≤–∫–∞: –≤—ã—à–µ —Ü–µ–ª–∏ (–≤–µ—Ä—Ö–Ω—è—è –ø–æ–ª–æ–≤–∏–Ω–∞) –∏–ª–∏ –Ω–∏–∂–µ —Ü–µ–ª–∏ (–Ω–∏–∂–Ω—è—è –ø–æ–ª–æ–≤–∏–Ω–∞)
      let insertIndex = to + (overBottomHalf ? 1 : 0);

      // –ï—Å–ª–∏ –º—ã –≤—ã—Ä–µ–∑–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–æ —Ç–æ—á–∫–∏ –≤—Å—Ç–∞–≤–∫–∏, –∏–Ω–¥–µ–∫—Å —Å–º–µ—â–∞–µ—Ç—Å—è –Ω–∞ -1
      if (from < insertIndex) insertIndex -= 1;

      if (insertIndex === from) return prev;
      return move(prev, from, insertIndex);
    });

    if (e.dataTransfer) e.dataTransfer.dropEffect = "move";
  };

  // –§—É–Ω–∫—Ü–∏–∏ –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞
  // const lastAutoScroll = useRef<number>(0);
  function autoScrollIfNearEdgeXY(
    container: HTMLElement,
    x: number,
    y: number
  ) {
    const now = performance.now();
    if (now - lastAutoScroll.current < 16) return; // ~60fps

    const margin = 60; // "—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è –∑–æ–Ω–∞" –≤–æ–∑–ª–µ –∫—Ä–∞—ë–≤
    const speed = 14; // –ø–∏–∫—Å–µ–ª–µ–π –∑–∞ —Ç–∏–∫

    const rect = container.getBoundingClientRect();

    // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª
    if (y < rect.top + margin) {
      container.scrollTop -= speed;
      lastAutoScroll.current = now;
    } else if (y > rect.bottom - margin) {
      container.scrollTop += speed;
      lastAutoScroll.current = now;
    }
  }

  // –£–Ω–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –∫–æ–º–º–∏—Ç –ø–æ—Ä—è–¥–∫–∞ (–∏ –æ—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ)
  async function persistOrderAndCleanup() {
    try {
      const res = await fetch("/api/todos/reorder", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ids: list.map((t) => t.id) }),
      });
      if (!res.ok) {
        throw new Error("Failed to reorder");
      }

      snapshotRef.current = null;
    } catch (err) {
      if (snapshotRef.current) setList(snapshotRef.current);
    } finally {
      setHoverId(null);
      setDragId(null);
      setTouchXY(null);
      setDragOffset(null);
      setDragSize(null);
      if (dragImageRef.current) {
        dragImageRef.current.remove();
        dragImageRef.current = null;
      }
    }
  }

  // ==== –ú–´–®–¨ (HTML5 DnD) ==== (—Å—Ç–∞—Ä—Ç—É–µ–º –¢–û–õ–¨–ö–û —Å —Ä—É—á–∫–∏)
  // –°–æ–∑–¥–∞—ë—Ç —Ç–µ–Ω–µ–≤–æ–π —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞, –∫–æ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ.
  const createShadow = (e: React.DragEvent<HTMLElement>) => {
    (e.currentTarget as HTMLElement).style.boxShadow =
      "0 8px 10px rgba(0,0,0,0.6)";
  };
  const clearShadow = (e: React.DragEvent<HTMLElement>) => {
    (e.currentTarget as HTMLElement).style.boxShadow = "";
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è. –°–æ–∑–¥–∞—ë—Ç "–ø—Ä–∏–∑—Ä–∞–∫" —ç–ª–µ–º–µ–Ω—Ç–∞ (–≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞), –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø–µ—Ä–µ–º–µ—â–∞—Ç—å—Å—è –ø–æ —ç–∫—Ä–∞–Ω—É –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏.
  const onHandleDragStart = (
    e: React.DragEvent<HTMLButtonElement>,
    id: string
  ) => {
    // —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –î–û –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –æ—Ç–∫–∞—Ç–∞
    snapshotRef.current = list;

    setDragId(id);

    const row = (e.currentTarget as HTMLElement).closest(
      "[data-id]"
    ) as HTMLElement | null;

    if (e.dataTransfer) {
      e.dataTransfer.effectAllowed = "move";

      if (row) {
        // –°—á–∏—Ç–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏ —Å–º–µ—â–µ–Ω–∏—è –¥–æ —Å—Ç–∞—Ä—Ç–∞
        const rect = row.getBoundingClientRect();
        const { clientX, clientY } = e;
        const offsetX = Math.max(0, clientX - rect.left);
        const offsetY = Math.max(0, clientY - rect.top);
        // –ö–ª–æ–Ω–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –∫–∞–∫ ¬´–ø—Ä–∏–∑—Ä–∞–∫¬ª
        const clone = row.cloneNode(true) as HTMLElement;
        // –í–ê–ñ–ù–û: —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–ª–æ–Ω–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö,
        // —á—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª w-full (100%)
        Object.assign(clone.style, {
          position: "fixed",
          top: "-10000px",
          left: "-10000px",
          pointerEvents: "none",
          boxShadow: "0 12px 20px rgba(0,0,0,0.45)",
          opacity: "1",
          width: `${rect.width}px`,
          height: `${rect.height}px`,
          boxSizing: "border-box",
        } as CSSStyleDeclaration);
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ):
        clone.classList.remove("w-full");
        document.body.appendChild(clone);
        dragImageRef.current = clone;
        // –ü–æ–¥–º–µ–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π ghost –Ω–∞ –Ω–∞—à –∫–ª–æ–Ω
        e.dataTransfer.setDragImage(clone, offsetX, offsetY);
      } else {
        // fallback: –ø—É—Å—Ç–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞
        const img = new Image();
        img.src =
          "data:image/svg+xml;charset=utf-8," +
          encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg"/>');
        e.dataTransfer.setDragImage(img, 0, 0);
      }
    }
  };

  const onRowDragEnd = async (e: React.DragEvent<HTMLDivElement>) => {
    clearShadow(e);
    await persistOrderAndCleanup();
  };

  const onRowDragOver = (e: React.DragEvent<HTMLDivElement>) => {
    e.preventDefault();
    createShadow(e);
  };

  const onRowDrop = (e: React.DragEvent<HTMLDivElement>) => {
    e.preventDefault();
    clearShadow(e);
    setHoverId(null);
    setDragId(null);
  };

  // ==== TOUCH DnD (—Å—Ç–∞—Ä—Ç—É–µ–º –¢–û–õ–¨–ö–û —Å —Ä—É—á–∫–∏) ====
  // –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–∞—Å–∞–Ω–∏—è. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É –∫–∞—Å–∞–Ω–∏—è –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è.
  const onHandleTouchStart = (
    e: React.TouchEvent<HTMLButtonElement>,
    id: string
  ) => {
    if (e.touches.length !== 1) return;

    // —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –î–û –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –æ—Ç–∫–∞—Ç–∞
    snapshotRef.current = list;

    const t = e.touches[0];
    const row = (e.currentTarget as HTMLElement).closest(
      "[data-id]"
    ) as HTMLElement | null;
    if (!row) return;
    const rect = row.getBoundingClientRect();

    setDragId(id);
    setTouchXY({ x: t.clientX, y: t.clientY });
    setDragOffset({ dx: t.clientX - rect.left, dy: t.clientY - rect.top });
    setDragSize({ w: rect.width, h: rect.height });
    setHoverId(id);
  };

  const onTouchMoveCapture = (e: React.TouchEvent<HTMLDivElement>) => {
    if (!dragId) return;
    e.preventDefault();

    const t = e.touches[0];
    const x = t.clientX;
    const y = t.clientY;
    setTouchXY({ x, y });

    // autoScrollIfNearEdge(y);
    // >>> –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª–∏–º –∏–º–µ–Ω–Ω–æ —Å–∫—Ä–æ–ª–ª-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (—Ä–æ–¥–∏—Ç–µ–ª—è), –∞ –Ω–µ –æ–∫–Ω–æ
    const scrollEl = getScrollParent(containerRef.current as HTMLElement);
    autoScrollIfNearEdgeXY(scrollEl, x, y);

    const el = elementFromPointIgnoringDragged(x, y, dragId);
    const row = el ? (el.closest("[data-id]") as HTMLElement | null) : null;

    if (!row) {
      setHoverId(null);
      return;
    }

    const targetId = row.dataset.id!;
    setHoverId(targetId);

    setList((prev) => {
      const from = prev.findIndex((tt) => tt.id === dragId);
      const to = prev.findIndex((tt) => tt.id === targetId);
      if (from === -1 || to === -1) return prev;

      const rect = row.getBoundingClientRect();
      const overBottomHalf = y - rect.top > rect.height / 2;

      let insertIndex = to + (overBottomHalf ? 1 : 0);
      if (from < insertIndex) insertIndex -= 1;

      if (insertIndex === from) return prev;
      return move(prev, from, insertIndex);
    });
  };

  const onTouchEndCapture = async () => {
    if (!dragId) return;
    await persistOrderAndCleanup();
  };

  //  touchcancel ‚Äî –∏–Ω–æ–≥–¥–∞ —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–º–µ–Ω—è–µ—Ç –∂–µ—Å—Ç
  const onTouchCancelCapture = async () => {
    if (!dragId) return;
    await persistOrderAndCleanup();
  };

  const draggingTodo = dragId ? list.find((t) => t.id === dragId) : null;

  // –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  async function handleToggleOptimistic(id: string, next: boolean) {
    // –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º UI
    setList((prev) =>
      prev.map((t) => (t.id === id ? { ...t, completed: next } : t))
    );

    // –ø—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    try {
      await toggleTodo(id); // –µ—Å–ª–∏ toggleTodo –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–æ–ª—å–∫–æ id
    } catch (e) {
      // –æ—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
      setList((prev) =>
        prev.map((t) => (t.id === id ? { ...t, completed: !next } : t))
      );
    }
  }

  // –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
  function handleDeleteOptimistic(id: string) {
    deleteSnapshotRef.current = list;
    setList((prev) => prev.filter((t) => t.id !== id));
  }
  function revertDelete() {
    if (deleteSnapshotRef.current) {
      setList(deleteSnapshotRef.current);
      deleteSnapshotRef.current = null;
    }
  }

  return (
    <div className="flow-root">
      <div className="min-w-full text-gray-900">
        <div
          className="bg-sky-200"
          ref={containerRef}
          onTouchMoveCapture={onTouchMoveCapture}
          onTouchEndCapture={onTouchEndCapture}
          onTouchCancelCapture={onTouchCancelCapture}
          onDragOverCapture={onMouseDragOverCapture}
        >
          {/* –ù–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ */}
          {incompleteTodos.map((todo) => {
            const isDragging = dragId === todo.id;
            return (
              <div
                key={todo.id}
                data-id={todo.id}
                // –í–ê–ñ–ù–û: —Å—Ç—Ä–æ–∫–∞ –ù–ï draggable
                onDragOver={onRowDragOver}
                onDragLeave={clearShadow}
                onDragEnd={onRowDragEnd}
                onDrop={onRowDrop}
                // –í–ê–ñ–ù–û: —É–±—Ä–∞–ª–∏ overflowY: "auto"
                style={{ touchAction: "pan-y" }} // overflowY –ø–æ –º–µ—Å—Ç—É
                className={[
                  `flex items-center bg-white border-gray-500 border-2 md:border-3 mb-1 md:mb-2 rounded w-full text-lg select-none transition-shadow shadow-[0_4px_8px_rgba(0,0,0,0.3)]
                  ${todo.completed ? "opacity-40" : ""}`,
                  isDragging ? "opacity-0" : "",
                ].join(" ")}
              >
                <CheckboxTodo
                  id={todo.id}
                  completed={todo.completed}
                  onToggle={(next) => handleToggleOptimistic(todo.id, next)}
                />

                <div className="w-full ml-2 select-text">{todo.title}</div>

                <div className="flex p-1 md:p-1 items-center justify-center gap-1">
                  <UpdateInvoiceTodo id={todo.id} />
                  <DeleteTodo
                    id={todo.id}
                    onOptimisticDelete={() => handleDeleteOptimistic(todo.id)}
                    onRevert={revertDelete}
                  />
                  {/* –†—É—á–∫–∞ DnD: –¢–û–õ–¨–ö–û —Ç—É—Ç –º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å */}
                  <button
                    type="button"
                    aria-label="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç—å"
                    className="p-1 cursor-grab active:cursor-grabbing touch-none border-gray-500 border-2 rounded hover:border-gray-800"
                    draggable
                    onDragStart={(e) => onHandleDragStart(e, todo.id)}
                    onTouchStart={(e) => onHandleTouchStart(e, todo.id)}
                  >
                    <TbArrowsUpDown className="w-5 h-5 " />
                  </button>
                </div>
              </div>
            );
          })}

          {/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å (–µ—Å–ª–∏ –µ—Å—Ç—å –æ–±–µ –≥—Ä—É–ø–ø—ã) */}
          {incompleteTodos.length > 0 && completedTodos.length > 0 && (
            <div className="flex items-center my-4">
              <div className="flex-grow border-t-2 border-gray-400"></div>
              <span className="px-3 text-sm text-gray-600">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
              <div className="flex-grow border-t-2 border-gray-400"></div>
            </div>
          )}

          {/* –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ */}
          {completedTodos.map((todo) => {
            const isDragging = dragId === todo.id;
            return (
              <div
                key={todo.id}
                data-id={todo.id}
                // –í–ê–ñ–ù–û: —Å—Ç—Ä–æ–∫–∞ –ù–ï draggable
                onDragOver={onRowDragOver}
                onDragLeave={clearShadow}
                onDragEnd={onRowDragEnd}
                onDrop={onRowDrop}
                // –í–ê–ñ–ù–û: —É–±—Ä–∞–ª–∏ overflowY: "auto"
                style={{ touchAction: "pan-y" }} // overflowY –ø–æ –º–µ—Å—Ç—É
                className={[
                  `flex items-center bg-white border-gray-500 border-2 md:border-3 mb-1 md:mb-2 rounded w-full text-lg select-none transition-shadow shadow-[0_4px_8px_rgba(0,0,0,0.3)]
                  ${todo.completed ? "opacity-40" : ""}`,
                  isDragging ? "opacity-0" : "",
                ].join(" ")}
              >
                {/* –†—É—á–∫–∞ DnD: –¢–û–õ–¨–ö–û —Ç—É—Ç –º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å */}
                <button
                  type="button"
                  aria-label="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç—å"
                  className="p-1 cursor-grab active:cursor-grabbing touch-none border-gray-500 border-2 rounded hover:border-gray-800 m-1"
                  draggable
                  onDragStart={(e) => onHandleDragStart(e, todo.id)}
                  onTouchStart={(e) => onHandleTouchStart(e, todo.id)}
                >
                  <TbArrowsUpDown className="w-5 h-5 " />
                </button>

                <div className="w-full ml-2 select-text">{todo.title}</div>

                <div className="flex p-1 md:p-1 items-center justify-end">
                  <CheckboxTodo
                    id={todo.id}
                    completed={todo.completed}
                    onToggle={(next) => handleToggleOptimistic(todo.id, next)}
                  />
                  <UpdateInvoiceTodo id={todo.id} />
                  <DeleteTodo
                    id={todo.id}
                    onOptimisticDelete={() => handleDeleteOptimistic(todo.id)}
                    onRevert={revertDelete}
                  />
                </div>
              </div>
            );
          })}
        </div>
      </div>

      {/* –ü—Ä–µ–≤—å—é –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–æ–¥ –ø–∞–ª—å—Ü–µ–º (—Ç–æ–ª—å–∫–æ –¥–ª—è touch) */}
      {dragId && touchXY && dragOffset && draggingTodo && (
        <div
          className="fixed z-50 pointer-events-none left-0 top-0 select-none"
          style={{
            transform: `translate(${touchXY.x - dragOffset.dx}px, ${
              touchXY.y - dragOffset.dy
            }px)`,
          }}
        >
          <div
            className={[
              "flex items-center bg-white border-gray-500 border-2 md:border-3 rounded text-sm",
              "shadow-[0_12px_20px_rgba(0,0,0,0.45)] ring-2 ring-amber-400",
            ].join(" ")}
            style={{
              width: dragSize?.w,
              height: dragSize?.h,
            }}
          >
            <div className="p-1 md:p-2">
              <TbArrowsUpDown className="w-5 h-5" />
            </div>
            <div className="w-full">{draggingTodo.title}</div>
            <div className="flex p-1 md:p-1 items-center justify-end">
              {/* –ù–µ–∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ –∏–∑-–∑–∞ pointer-events: none –Ω–∞ –≤—Ä–∞–ø–ø–µ—Ä–µ */}

              <UpdateInvoiceTodo id={draggingTodo.id} />
              {/* <DeleteTodo title={draggingTodo.title} /> */}
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// app/ui/todo/checkbox-todo.tsx ====================================================================
import { GiCheckMark } from "react-icons/gi";

type Props = {
  id: string;
  completed: boolean;
  onToggle?: (next: boolean) => void;
};

export function CheckboxTodo({ completed, onToggle }: Props) {
  return (
    <button
      type="button"
      onClick={() => onToggle?.(!completed)}
      className={`p-1 m-1 border-2 rounded cursor-pointer active:bg-green-700 transition-colors duration-150 ease-out ${
        completed
          ? "border-green-700 bg-green-50"
          : "border-gray-500 hover:border-green-700"
      }`}
      aria-pressed={completed}
      aria-label={
        completed ? "–°–Ω—è—Ç—å –æ—Ç–º–µ—Ç–∫—É –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏" : "–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ"
      }
      title={
        completed ? "–°–Ω—è—Ç—å –æ—Ç–º–µ—Ç–∫—É –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏" : "–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ"
      }
    >
      <GiCheckMark
        className={`w-5 h-5 ${
          completed ? "text-green-700" : "hover:text-green-700"
        }`}
      />
    </button>
  );
}


// app/ui/login-form.tsx ============================================================================
"use client";
import { lusitana } from "@/app/ui/fonts";
import {
  AtSymbolIcon,
  KeyIcon,
  ExclamationCircleIcon,
  EyeIcon,
  EyeSlashIcon,
} from "@heroicons/react/24/outline";
import { ArrowRightIcon } from "@heroicons/react/20/solid";
import { Button } from "./button";
import { useActionState, useState } from "react";
import { authenticate } from "@/app/lib/actions";
import { useSearchParams } from "next/navigation";
import { signIn as signInClient } from "next-auth/react";

export default function LoginForm() {
  const searchParams = useSearchParams();
  const callbackUrl = searchParams.get("callbackUrl") || "/dashboard";
  const [errorMessage, formAction, isPending] = useActionState(
    authenticate,
    undefined
  );
  const [showPassword, setShowPassword] = useState(false);

  return (
    <form action={formAction} className="space-y-3">
      <div className="flex-1 rounded-lg bg-gray-200 px-6 pb-4 pt-8">
        <h1 className={`${lusitana.className} mb-3 text-2xl`}>
          –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        </h1>
        <div className="w-full">
          <div>
            <label
              className="mb-3 mt-5 block text-xs font-medium text-gray-900"
              htmlFor="email"
            >
              Email
            </label>
            <div className="relative">
              <input
                className="peer block w-full rounded-md border border-gray-200 py-[9px] pl-10 text-sm outline-2 placeholder:text-gray-500"
                id="email"
                type="email"
                name="email"
                placeholder="Enter your email address"
                required
              />
              <AtSymbolIcon className="pointer-events-none absolute left-3 top-1/2 h-[18px] w-[18px] -translate-y-1/2 text-gray-500 peer-focus:text-gray-900" />
            </div>
          </div>
          <div className="mt-4">
            <label
              className="mb-3 mt-5 block text-xs font-medium text-gray-900"
              htmlFor="password"
            >
              –ü–∞—Ä–æ–ª—å
            </label>
            <div className="relative">
              <input
                className="peer block w-full rounded-md border border-gray-200 py-[9px] pl-10 pr-10 text-sm outline-2 placeholder:text-gray-500"
                id="password"
                type={showPassword ? "text" : "password"}
                name="password"
                placeholder="Enter password"
                required
                minLength={6}
              />
              <KeyIcon className="pointer-events-none absolute left-3 top-1/2 h-[18px] w-[18px] -translate-y-1/2 text-gray-500 peer-focus:text-gray-900" />
              <button
                type="button"
                onClick={() => setShowPassword(!showPassword)}
                className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-900 focus:outline-none"
                aria-label={showPassword ? "–°–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å" : "–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å"}
              >
                {showPassword ? (
                  <EyeSlashIcon className="h-[18px] w-[18px]" />
                ) : (
                  <EyeIcon className="h-[18px] w-[18px]" />
                )}
              </button>
            </div>
          </div>
        </div>
        <input type="hidden" name="redirectTo" value={callbackUrl} />
        <Button
          className="h-10 px-4 mt-4 w-full text-shadow-lg/40 5 5"
          aria-disabled={isPending}
        >
          –í–æ–π—Ç–∏ <ArrowRightIcon className="ml-auto h-5 w-5 text-gray-50" />
        </Button>

        {/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å */}
        <div className="my-4 flex items-center">
          <div className="h-px flex-1 bg-gray-300" />
          <span className="px-3 text-xs text-gray-500">–∏–ª–∏</span>
          <div className="h-px flex-1 bg-gray-300" />
        </div>

        {/* –ö–Ω–æ–ø–∫–∞ Google */}
        <button
          type="button"
          onClick={() => signInClient("google", { redirectTo: callbackUrl })}
          className="h-10 w-full rounded-md bg-white hover:bg-gray-50 text-gray-900 border border-gray-300 text-sm font-medium"
        >
          –í–æ–π—Ç–∏ —Å Google
        </button>

        <div
          aria-live="polite"
          aria-atomic="true"
          className="flex h-8 items-end space-x-1"
        >
          {/* Add form errors here */}
          {errorMessage && (
            <>
              <ExclamationCircleIcon className="h-5 w-5 text-red-500" />
              <p className="text-sm text-red-500">{errorMessage}</p>
            </>
          )}
        </div>
        <p className="mt-2 text-center text-sm text-gray-600">
          –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?{" "}
          <a className="text-blue-600 underline" href="/register">
            –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
          </a>
        </p>
      </div>
    </form>
  );
}

// app/ui/register-form.tsx =========================================================================
"use client";

import { useActionState, useState } from "react";
import { useSearchParams } from "next/navigation";
import { ArrowRightIcon } from "@heroicons/react/20/solid";
import {
  AtSymbolIcon,
  KeyIcon,
  UserIcon,
  ExclamationCircleIcon,
  EyeIcon,
  EyeSlashIcon,
} from "@heroicons/react/24/outline";
import { register, type RegisterState } from "@/app/lib/actions";
import { Button } from "./button";
import { lusitana } from "@/app/ui/fonts";

export default function RegisterForm() {
  const searchParams = useSearchParams();
  const callbackUrl = searchParams.get("callbackUrl") || "/dashboard";

  const [state, formAction, isPending] = useActionState<
    RegisterState,
    FormData
  >(register, { ok: false });

  const [showPassword, setShowPassword] = useState(false);

  return (
    <form action={formAction} className="space-y-3">
      <div className="flex-1 rounded-lg bg-gray-200 px-6 pb-4 pt-8">
        <h1 className={`${lusitana.className} mb-3 text-2xl`}>
          –°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç
        </h1>

        <div className="w-full">
          {/* Name */}
          <label
            className="mb-2 mt-3 block text-xs font-medium text-gray-900"
            htmlFor="name"
          >
            –ò–º—è
          </label>
          <div className="relative">
            <input
              className="peer block w-full rounded-md border border-gray-200 py-[9px] pl-10 text-sm outline-2 placeholder:text-gray-500"
              id="name"
              name="name"
              type="text"
              placeholder="–í–∞—à–µ –∏–º—è"
              required
            />
            <UserIcon className="pointer-events-none absolute left-3 top-1/2 h-[18px] w-[18px] -translate-y-1/2 text-gray-500 peer-focus:text-gray-900" />
          </div>
          {state?.errors?.name && (
            <p className="mt-1 text-xs text-red-500">{state.errors.name}</p>
          )}

          {/* Email */}
          <label
            className="mb-2 mt-4 block text-xs font-medium text-gray-900"
            htmlFor="email"
          >
            Email
          </label>
          <div className="relative">
            <input
              className="peer block w-full rounded-md border border-gray-200 py-[9px] pl-10 text-sm outline-2 placeholder:text-gray-500"
              id="email"
              name="email"
              type="email"
              placeholder="you@example.com"
              required
            />
            <AtSymbolIcon className="pointer-events-none absolute left-3 top-1/2 h-[18px] w-[18px] -translate-y-1/2 text-gray-500 peer-focus:text-gray-900" />
          </div>
          {state?.errors?.email && (
            <p className="mt-1 text-xs text-red-500">{state.errors.email}</p>
          )}

          {/* Password */}
          <label
            className="mb-2 mt-4 block text-xs font-medium text-gray-900"
            htmlFor="password"
          >
            –ü–∞—Ä–æ–ª—å
          </label>
          <div className="relative">
            <input
              className="peer block w-full rounded-md border border-gray-200 py-[9px] pl-10 pr-10 text-sm outline-2 placeholder:text-gray-500"
              id="password"
              type={showPassword ? "text" : "password"}
              name="password"
              placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤"
              required
              minLength={6}
            />
            <KeyIcon className="pointer-events-none absolute left-3 top-1/2 h-[18px] w-[18px] -translate-y-1/2 text-gray-500 peer-focus:text-gray-900" />
            <button
              type="button"
              onClick={() => setShowPassword(!showPassword)}
              className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-900 focus:outline-none"
              aria-label={showPassword ? "–°–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å" : "–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å"}
            >
              {showPassword ? (
                <EyeSlashIcon className="h-[18px] w-[18px]" />
              ) : (
                <EyeIcon className="h-[18px] w-[18px]" />
              )}
            </button>
          </div>
          {state?.errors?.password && (
            <p className="mt-1 text-xs text-red-500">{state.errors.password}</p>
          )}

          {/* Confirm */}
          <label
            className="mb-2 mt-4 block text-xs font-medium text-gray-900"
            htmlFor="confirm"
          >
            –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å
          </label>
          <div className="relative">
            <input
              className="peer block w-full rounded-md border border-gray-200 py-[9px] pl-10 pr-10 text-sm outline-2 placeholder:text-gray-500"
              id="confirm"
              name="confirm"
              type={showPassword ? "text" : "password"}
              placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
              required
              minLength={6}
            />
            <KeyIcon className="pointer-events-none absolute left-3 top-1/2 h-[18px] w-[18px] -translate-y-1/2 text-gray-500 peer-focus:text-gray-900" />
            <button
              type="button"
              onClick={() => setShowPassword(!showPassword)}
              className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-900 focus:outline-none"
              aria-label={showPassword ? "–°–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å" : "–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å"}
            >
              {showPassword ? (
                <EyeSlashIcon className="h-[18px] w-[18px]" />
              ) : (
                <EyeIcon className="h-[18px] w-[18px]" />
              )}
            </button>
          </div>
          {state?.errors?.confirm && (
            <p className="mt-1 text-xs text-red-500">{state.errors.confirm}</p>
          )}
        </div>

        {/* redirectTo, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ø–∞–¥–∞—Ç—å —Ç—É–¥–∞ –∂–µ, –∫—É–¥–∞ –∏ –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ */}
        <input type="hidden" name="redirectTo" value={callbackUrl} />

        <Button
          className="h-10 px-4 mt-4 w-full text-shadow-lg/40 5 5"
          aria-disabled={isPending}
        >
          –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
          <ArrowRightIcon className="ml-auto h-5 w-5 text-gray-50" />
        </Button>

        {/* –û–±—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è */}
        <div
          aria-live="polite"
          aria-atomic="true"
          className="flex h-8 items-end space-x-1"
        >
          {state?.message && (
            <>
              <ExclamationCircleIcon className="h-5 w-5 text-amber-500" />
              <p className="text-sm text-amber-600">{state.message}</p>
            </>
          )}
        </div>

        <p className="mt-2 text-center text-sm text-gray-600">
          –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?{" "}
          <a className="text-blue-600 underline" href="/login">
            –í–æ–π—Ç–∏
          </a>
        </p>
      </div>
    </form>
  );
}

// app/layout.tsx ====================================================================================
import "@/app/ui/global.css";
import { inter } from "./ui/fonts";

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en" className="h-full">
      <body className={`${inter.className} antialiased h-full`}>
        {children}
      </body>
    </html>
  );
}

// app/page.tsx =====================================================================================
import Link from "next/link";
import { lusitana } from "./ui/fonts";
import { CiLogin } from "react-icons/ci";

export default function Page() {
  return (
    <main className="flex min-h-screen flex-col p-6">
      <div className="flex h-20 shrink-0 justify-center items-center rounded-lg text-shadow-lg/40 shadow-[0_4px_8px_rgba(0,0,0,0.5)] bg-gradient-to-br from-blue-200 to-blue-600 p-4 md:h-52">
        <div
          className={`${lusitana.className} flex items-center leading-none text-white`}
        >
          <p className="text-[44px]">myDay24</p>
        </div>
      </div>
      <div className="mt-4 flex justify-center items-center gap-4 md:flex-row">
        <Link
          href="/login"
          className="flex items-center gap-5 self-start rounded-lg px-6 py-3 text-sm font-medium text-white transition-colors hover:bg-blue-400 md:text-base text-shadow-lg/40 shadow-[0_4px_8px_rgba(0,0,0,0.5)] bg-gradient-to-br from-blue-200 to-blue-600 hover:to-blue-800 "
        >
          <span>–í–æ–π—Ç–∏</span> <CiLogin className="w-8 h-8" />
        </Link>
      </div>
    </main>
  );
}

// auth.config.ts =====================================================================================
import type { NextAuthConfig } from "next-auth";

export const authConfig = {
  pages: {
    signIn: "/login",
  },
  callbacks: {
    authorized({ auth, request: { nextUrl } }) {
      const isLoggedIn = !!auth?.user;
      const isOnDashboard = nextUrl.pathname.startsWith("/dashboard");
      if (isOnDashboard) {
        if (isLoggedIn) return true;
        return false; // Redirect unauthenticated users to login page
      } else if (isLoggedIn) {
        return Response.redirect(new URL("/dashboard", nextUrl));
      }
      return true;
    },
  },
  providers: [], // Add providers with an empty array for now
} satisfies NextAuthConfig;

// auth.ts ===========================================================================================
import NextAuth from "next-auth";
import { authConfig } from "./auth.config";
import Credentials from "next-auth/providers/credentials";
import Google from "next-auth/providers/google";
import { z } from "zod";
import type { User } from "@/app/lib/definitions";
import bcrypt from "bcryptjs";
import postgres from "postgres";
import type { JWT } from "next-auth/jwt";

const sql = postgres(process.env.POSTGRES_URL!, { ssl: "require" });

async function getUser(email: string): Promise<User | undefined> {
  try {
    const user = await sql<User[]>`SELECT * FROM users WHERE email=${email}`;
    return user[0];
  } catch (error) {
    console.error("Failed to fetch user:", error);
    throw new Error("Failed to fetch user.");
  }
}

export const {
  auth,
  signIn,
  signOut,
  handlers: { GET, POST },
} = NextAuth({
  ...authConfig,
  providers: [
    Google({
      clientId: process.env.AUTH_GOOGLE_ID!,
      clientSecret: process.env.AUTH_GOOGLE_SECRET!,
      allowDangerousEmailAccountLinking: true,
      authorization: {
        params: {
          scope: "openid email profile",
          prompt: "consent",
          access_type: "offline",
          response_type: "code",
        },
      },
    }),
    Credentials({
      async authorize(credentials) {
        const parsed = z
          .object({ email: z.email(), password: z.string().min(6) })
          .safeParse(credentials);
        if (!parsed.success) return null;

        const { email, password } = parsed.data;
        const user = await getUser(email);
        if (!user) return null;

        const ok = await bcrypt.compare(password, user.password);
        if (!ok) return null;

        // –í–ê–ñ–ù–û: –≤–µ—Ä–Ω—É—Ç—å –æ–±—ä–µ–∫—Ç —Å id, —á—Ç–æ–±—ã jwt –ø–æ–ª—É—á–∏–ª –µ–≥–æ —Å—Ä–∞–∑—É
        return { id: user.id, name: user.name, email: user.email };
      },
    }),
  ],

  callbacks: {
    // —Å–æ–∑–¥–∞–µ–º/–ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
    async signIn({ user, account, profile }) {
      if (account?.provider === "google") {
        const email = user?.email;
        const name = user?.name || (profile as any)?.name || "GoogleUser";

        if (!email) {
          console.error("Google sign-in: No email provided");
          return false;
        }

        try {
          // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
          await sql`
            INSERT INTO users (name, email, password)
            VALUES (${name}, ${email}, ${null})
            ON CONFLICT (email) DO NOTHING
          `;
          console.log("Google user ensured in DB:", email);
        } catch (e) {
          console.error("Failed to create Google user:", e);
          return false;
        }
      }
      return true;
    },

    async jwt({ token, user, account }) {
      // –î–ª—è Credentials –±–µ—Ä–µ–º id –Ω–∞–ø—Ä—è–º—É—é (—ç—Ç–æ —É–∂–µ –Ω–∞—à DB id)
      if (user?.id && account?.provider === "credentials") {
        token.userId = user.id;
        console.log("JWT: userId from Credentials:", user.id);
      }
      // –î–ª—è Google (–∏–ª–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞) - –í–°–ï–ì–î–ê –ø–æ–ª—É—á–∞–µ–º –∏–∑ –ë–î
      else if (
        token.email &&
        (!token.userId || account?.provider === "google")
      ) {
        const dbUser = await getUser(token.email);
        if (dbUser) {
          token.userId = dbUser.id;
          console.log("JWT: userId from DB:", dbUser.id, "for", token.email);
        } else {
          console.error("JWT: No user in DB for:", token.email);
        }
      }

      return token as JWT & { userId?: string };
    },

    // –ü–µ—Ä–µ–¥–∞–µ–º userId –≤ —Å–µ—Å—Å–∏—é
    async session({ session, token }) {
      if (token?.userId) {
        // ts-expect-error —Ä–∞—Å—à–∏—Ä—è–µ–º —Ç–∏–ø
        session.user.id = token.userId as string;
        console.log("Session: userId set:", token.userId);
      } else {
        console.error("Session: No userId in token!");
      }
      return session;
    },

    ...authConfig.callbacks,
  },
});


// middleware.ts ======================================================================================
import NextAuth from "next-auth";
import { authConfig } from "./auth.config";

export default NextAuth(authConfig).auth;

export const config = {
  // https://nextjs.org/docs/app/building-your-application/routing/middleware#matcher
  matcher: ["/((?!api|_next/static|_next/image|.*\\.png$).*)"],
  runtime: "nodejs",
};